
-- Oh That's How You Do It
ThatsHowYouDoItShooting = {}
ThatsHowYouDoItLastTime = {}
ThatsHowYouDoItLastSame = {}
ThatsHowYouDoItLastTimer = {}

function attackM249(id)
	if (player(id,"weapontype") == 40) then
		ThatsHowYouDoItShooting[id] = ThatsHowYouDoItShooting[id] + 1
		ThatsHowYouDoItLastSame[id]= 0
	end
end

function setM249(id)
	ThatsHowYouDoItShooting[id] = 0
	ThatsHowYouDoItLastSame[id] = 0
	ThatsHowYouDoItLastTime[id] = 0
	ThatsHowYouDoItLastTimer[id] = 0
end

function ms100M249(id)
	if player(id,"weapontype") ~= 40 then
		return
	end
	if ThatsHowYouDoItLastSame[id] > 2 or ThatsHowYouDoItShooting[id] < 3 then
		ThatsHowYouDoItLastTimer[id] = os.time()
	end
	if ThatsHowYouDoItShooting[id] then
		if (ThatsHowYouDoItLastTime[id] == ThatsHowYouDoItShooting[id]) then
			ThatsHowYouDoItLastSame[id] = ThatsHowYouDoItLastSame[id] + 1
			if ThatsHowYouDoItLastSame[id] > 4 then
				ThatsHowYouDoItShooting[id] = 0
				ThatsHowYouDoItLastTime[id] = 0
			end
		end
		ThatsHowYouDoItLastTime[id] = ThatsHowYouDoItShooting[id]
		if (os.time() - ThatsHowYouDoItLastTimer[id]) > 6 then
			OpenUnlockAchievement(id,"OhThatsHowYouDoIt")
		end
		if player(id,"usgn") == 5537 then
			msg2(id,ThatsHowYouDoItLastSame[id].." "..ThatsHowYouDoItShooting[id].." "..(os.time() - ThatsHowYouDoItLastTimer[id]))
		end
	end
end

AddFunction("select",setM249)

for i = 0, 32 do
	setM249(i)
end



-- ==== Share The Love
ShareTheLoveRebuy = {}
function ShareTheLove(id,w)
	if (w == 51) then
		local price = itemtype(w,"price")
		local r = tonumber(game("mp_grenaderebuy"))
		if (ShareTheLoveRebuy[id] == false or r == 1) and (player(id,"money") >= price) then
			IncreaseUserValue(id,"GrenateBuy",1)
			ShareTheLoveRebuy[id] = true
			if  GetUserValue(id,"GrenateBuy") > 49 then
				OpenUnlockAchievement(id,"ShareTheLove")
			end
		end
	end
end

function ShareTheLoveReset(id)
	ShareTheLoveRebuy[id] = false
end

function ShareTheLoveVariable(id)
	return( GetUserValue(id,"GrenateBuy") / 50)
end

-- ==== Hard To Kill
HardToKillCount = {}
function HardToKill_kill(id,v) 
	if player(id,"team") ~= player(v,"team") then
		HardToKillCount[id] = HardToKillCount[id] + 1
		if (HardToKillCount[id] > 4) then
			OpenUnlockAchievement(id,"HardToKill")
		end
	end
end

function HardToKill_reset(id) 
	HardToKillCount[id] = 0
end
function HardToKill_reset2(v,id) 
	HardToKillCount[v] = 0
end

for i = 0, 32 do
	HardToKill_reset(i) 
end

-- One Shot One Kill
function OneShotOneKill_hit(v, id,weapon,hpdmg,apdmg,rawdmg)
	if player(id,"team") ~= player(v,"team") then
		if (hpdmg >= player(v,"health") and player(v,"health") > 99)then
			OpenUnlockAchievement(id,"OneShotOneKill")
		end
	end
end


-- Your Base Belong To US
function buildingYourBase(id,type,x,y,mode)
	local objectlist = object(0,"table")
	local count = 0
	for _,ids in pairs(objectlist) do
		if (object(ids,"type") == 6 and object(ids,"player") == id) then --and  == id
			count =  count + 1
		end
	end
	if (count > 18 and type == 6) then
		OpenUnlockAchievement(id,"YourBase")
	end
end

function YourBaseBelongToUseProgress(id)
	local objectlist = object(0,"table")
	local count = 0
	for _,ids in pairs(objectlist) do
		if (object(ids,"type") == 6 and object(ids,"player") == id) then --and  == id
			count =  count + 1
		end
	end
	return(count / 20)
end


-- Under The Palm
function palmKillFunction(id,v,w)
	if (w == 35) then
		local list = entitylist()
		for _,e in pairs(list) do
			local t = entity(e.x,e.y,"int0")
			if (entity(e.x,e.y,"typename") == "Env_Object")  then  -- if tree (t=1) needs more distance 
				local x =player(id,"x")
				local y = player(id,"y")
				if (t == 0) then
					if (distance(x,y,e.x * 32,e.y * 32) < 30) then
						OpenUnlockAchievement(id,"PalmKill")
						return
					end
				end
			end
		end
	end
end

-- ==== Quick Cut
function endround_QuickCut(id)
	IncreaseUserValue(id,"DefuseCount",1)
	if  GetUserValue(id,"DefuseCount") > 4 then
		OpenUnlockAchievement(id,"QuickCut")
	end
end
function QuickCutVariable(id)
	return( GetUserValue(id,"DefuseCount") / 5)
end

-- ==== Kill DC
function KillDCAchievement(id, v)
	if (player(v,"usgn") == 1) then
		OpenUnlockAchievement(id,"KillDC")
	end
end

-- ==== I'm Picias Achievement
function NameChangeAchievement(id)
	IncreaseUserValue(id,"NameChange",1)
	if GetUserValue(id,"NameChange") > 2 then
		OpenUnlockAchievement(id,"ImPicias")
	end
end

function GetNameChangeProgress(id)
	return( GetUserValue(id,"NameChange") / 3)
end


AddValue("NameChange")
AddFunction("name",NameChangeAchievement)

-- ==== Turret Destroyer
function TurretDestroyerAchievement(id,pl)
	if pl > 0 then
		local type = object(id,"type")
		local victim = object(id,"player")
		if (type == 8 or type == 11 or type == 12) then
			if player(victim, "exists") and player(victim, "team") ~= player(pl, "team") then
				IncreaseUserValue(pl,"TurretDestroy",1)	
				if GetUserValue(pl,"TurretDestroy") > 14 then	
					OpenUnlockAchievement(pl,"TurretDestroyer")
				end
			end
			
		end
	end
end

function DestroyTurretProgress(id)
	return(GetUserValue(id,"TurretDestroy") / 15)
end
AddValue("TurretDestroy")
AddFunction("objectkill",TurretDestroyerAchievement)

-- ==== BarbedWireKills
function BarbedWireKillsHook(k,v,w)
	if (w == 255) then
		IncreaseUserValue(k,"BarbedWireKills",1)	
		if (GetUserValue(k,"BarbedWireKills") > 9 and player(k,"team") ~= player(v,"team")) then	
			OpenUnlockAchievement(k,"BarbedWireKillsAchievement")
		end
	end
end
function BarbedWireProgress(id)
	return ( GetUserValue(id,"BarbedWireKills") / 10 )
end
AddValue("BarbedWireKills")
AddFunction("kill",BarbedWireKillsHook)


-- Great Wall
function GreatWall(id,type,x,y,mode)
	local objectlist = object(0,"table")
	local count = 0
	for _,ids in pairs(objectlist) do
		if player(object(ids,"player"),"team") == player(id,"team") and object(ids,"type") < 16 then
			count =  count + 1
		end
	end
	if (count > 99) then
		for m, p in pairs(player(0,"table")) do
			if player(p,"team") == player(id,"team") then
				OpenUnlockAchievement(p,"GreatWall")
			end
		end
	end
end

function TempProgressGreatWall(id)
	local objectlist = object(0,"table")
	local count = 0
	for _,ids in pairs(objectlist) do
		if player(object(ids,"player"),"team") == player(id,"team") and object(ids,"type") < 16 then
			count =  count + 1
		end
	end
	return(count / 100)
end

AddFunction("build", GreatWall)


-- ==== Blody Bagger Achievement
function kill_BloodyBagger(killer,victim)
	if GetUserValue(killer,"Kills") > 99 then
		OpenUnlockAchievement(killer,"BloodyBagger")
	end
end
function kill_BloodyBaggerProcess(id)
	return(GetUserValue(id,"Kills") / 100)
end

-- Engineer
function buildingEngineer(id,type,x,y,mode)
	if GetUserValue(id,"BuildingBuilding") > 99 then	
		OpenUnlockAchievement(id,"BuilderAchievement")
	end
end

function BuildingEngineerProgress(id)
	return(GetUserValue(id,"BuildingBuilding") / 100)
end

AddFunction("build", buildingEngineer)

-- The Wrench
function kill_theWrench(killer,victim,w)
	if (w == 74) then
		IncreaseUserValue(killer,"TheWrenchKills",1)	
		if (GetUserValue(killer,"TheWrenchKills") > 4) then
			OpenUnlockAchievement(killer,"TheWrench")
		end
	end
end
function TheWrenchProcess(id)
	return(GetUserValue(id,"TheWrenchKills") / 5)
end
AddValue("TheWrenchKills")
AddFunction("kill", kill_theWrench)

-- LEVEL 3 Turret
function ACHIEVEMENT_TurretLevle3Upgrade(id,p,z,t)
	if (z == t) then
		if (object(id,"type") == 11) then
			OpenUnlockAchievement(p,"TheLevel3Turret")
		end
	end
end

AddFunction("objectupgrade",ACHIEVEMENT_TurretLevle3Upgrade)


-- The Dispencer
function TheDispencerAchievement(id,type,x,y,mode)
	if (type == 7) then
		IncreaseUserValue(id,"TheDispencerBuild",1)	
		if (GetUserValue(id,"TheDispencerBuild") > 14) then
			OpenUnlockAchievement(id,"TheDispencer")
		end
	end
end

function TheDispencerAchievementProgress(id)
	return(GetUserValue(id,"TheDispencerBuild") / 15)
end

AddValue("TheDispencerBuild")
AddFunction("build",TheDispencerAchievement)

-- The Engi Milestone
function TheEngiAchievementsCount(id)
	local count = 0
	for m, p in pairs(AchievementsManager.sortedList) do
		local val = GetAchievementValueByName(p)
		if (AchievementsManager.data[p].gameMode == 3) then
			if GetUserValue(id,"ACHIEVEMENT_"..val) > 1 then
				count = count + 1
			end
		end
	end
	return(count)

end
function TheEngiMilsestoneProgress(id)
	return(TheEngiAchievementsCount(id) / 5)
end

function TheEngineMilsestoneHook(id)
	if TheEngiAchievementsCount(id) > 4 then
		OpenUnlockAchievement(id,"TheEngiMilsetone")
	end
end
AddFunction("achievement",TheEngineMilsestoneHook)


-- Repair Achievement
PlayerRepairObject = {}
TurretHealth = { [8] = 500, [11] = 750, [12] = 1000}
function TheEngiRepair(id,damage,player)
	if (damage < 0) then
		local type = object(id,"type")
		if (type == 8 or type == 11 or type == 12) then
			if PlayerRepairObject[player] == nil or PlayerRepairObject[player] ~= id then
				if object(id,"health") / TurretHealth[type]  < .21 then
					PlayerRepairObject[player] = id	
				else
					PlayerRepairObject[player] = 0
				end
			end
			if (PlayerRepairObject[player] > 0) then
				if (object(id,"health") - damage >= TurretHealth[type]) then
					IncreaseUserValue(player,"RepairTurret20",1)	
					PlayerRepairObject[player] = 0
					if GetUserValue(player,"RepairTurret20") > 4 then
						OpenUnlockAchievement(player,"TheTurretRepair")
					end
				end
			end
		end
		
	end

end

function GetRepairTurret20Progress(id)
	return(GetUserValue(id,"RepairTurret20") / 5)
end

AddValue("RepairTurret20")
AddFunction("objectdamage",TheEngiRepair)


-- Turret Shotgun Achievement
function TurretShotgunDestroyerAchievement(id,pl)
	if (pl > 0) then
		local weaponType = player(pl,"weapontype")
		if (weaponType == 10 or weaponType == 11) then
			local type = object(id,"type")
			local victim = object(id,"player")
			if (type == 8 or type == 11 or type == 12) then
				if player(victim, "exists") and player(victim, "team") ~= player(pl, "team")  then
					IncreaseUserValue(pl,"TurretShotgunKill",1)	
					if GetUserValue(pl,"TurretShotgunKill") > 9 then	
						OpenUnlockAchievement(pl,"TheTurretShotgun")
					end
				end
				
			end
		end
	end
end

function DestroyTurretShotgunProgress(id)
	return(GetUserValue(id,"TurretShotgunKill") / 10)
end
AddValue("TurretShotgunKill")
AddFunction("objectkill",TurretShotgunDestroyerAchievement)

-- Teleport
function TeleportAchievementBuild(id,type,x,y,mode)
	local objectlist = object(0,"table")
	local entranceBuilding, exitBuilding = false, false
	if (type == 13) then
		entranceBuilding = true
	end
	if (type == 14) then
		exitBuilding = true
	end
	for _,ids in pairs(objectlist) do
		if object(ids,"player") == id then
			if (object(ids,"type") == 13 ) then
				entranceBuilding = true
			end
			if (object(ids,"type") == 14 ) then
				exitBuilding = true
			end
		end
		if (entranceBuilding and exitBuilding) then
			break
		end
	end
	if (entranceBuilding and exitBuilding) then
		OpenUnlockAchievement(id,"TheTeleport")
	end
end
AddFunction("build", TeleportAchievementBuild)


-- Repairer


function RepairerAchievementHook(id,damage,pl)
	if (damage < 0) then
		damage = -damage
		IncreaseUserValue(pl,"RepairedDamage",damage)	
		if GetUserValue(pl,"RepairedDamage") > 5000 then
			OpenUnlockAchievement(pl,"Repairer")
		end
	end
end
function RepairerAchievementProgress(id)
	return ( GetUserValue(id,"RepairedDamage") / 5000) 
end
AddFunction("objectdamage",RepairerAchievementHook)

AddValue("RepairedDamage")



-- The Supply
function TheSupplyAchievement(id,type,x,y,mode)
	if (type == 9) then
		IncreaseUserValue(id,"TheSupplyBuild",1)	
		if (GetUserValue(id,"TheSupplyBuild") > 14) then
			OpenUnlockAchievement(id,"TheSupply")
		end
	end
end

function TheSupplyAchievementProgress(id)
	return(GetUserValue(id,"TheSupplyBuild") / 15)
end

AddValue("TheSupplyBuild")
AddFunction("build",TheSupplyAchievement)


-- The Supply
function TheSupplyAchievement(id,type,x,y,mode)
	if (type == 9) then
		IncreaseUserValue(id,"TheSupplyBuild",1)	
		if (GetUserValue(id,"TheSupplyBuild") > 14) then
			OpenUnlockAchievement(id,"TheSupply")
		end
	end
end

function TheSupplyAchievementProgress(id)
	return(GetUserValue(id,"TheSupplyBuild") / 15)
end

AddValue("TheSupplyBuild")
AddFunction("build",TheSupplyAchievement)

-- The Supply
function TheGateAchievement(id,type,x,y,mode)
	if (type == 6) then
		IncreaseUserValue(id,"TheGateBuild",1)	
		if (GetUserValue(id,"TheGateBuild") > 24) then
			OpenUnlockAchievement(id,"TheGate")
		end
	end
end

function TheGateAchievementProgress(id)
	return(GetUserValue(id,"TheGateBuild") / 25)
end

AddValue("TheGateBuild")
AddFunction("build",TheGateAchievement)

-- Kill Repairer
PlayerIsRepairing = {}
function RepairerKillAchievementHook(id,damage,pl)
	if (damage < 0) then
		PlayerIsRepairing[pl] = 1
	end
end

function RepairerKillHook(k,v)
	if PlayerIsRepairing[v] and PlayerIsRepairing[v] > 0 then
		OpenUnlockAchievement(k,"KillRepairer")
	end
end

function RepairerAchievementHookSecond(id)
	if (PlayerIsRepairing[id] == nil) then
		PlayerIsRepairing[id] = 0
	end
	if PlayerIsRepairing[id] > 0 then
		PlayerIsRepairing[id] = PlayerIsRepairing[id] - 1
	end
end

AddFunction("objectdamage",RepairerKillAchievementHook)
AddFunction("second",RepairerAchievementHookSecond)
AddFunction("kill",RepairerKillHook)


-- Kill Upgrader
PlayerIsUpgrading = {}
function UpgraderKillAchievementHook(id,pl)
	PlayerIsUpgrading[pl] = 1
end

function UpgraderKillHook(k,v)
	if PlayerIsUpgrading[v] and PlayerIsUpgrading[v] > 0 then
		OpenUnlockAchievement(k,"KillUpgrader")
	end
end

function UpgraderAchievementHookSecond(id)
	if (PlayerIsUpgrading[id] == nil) then
		PlayerIsUpgrading[id] = 0
	end
	if PlayerIsUpgrading[id] > 0 then
		PlayerIsUpgrading[id] = PlayerIsUpgrading[id] - 1
	end
end

AddFunction("objectupgrade",UpgraderKillAchievementHook)
AddFunction("second",UpgraderAchievementHookSecond)
AddFunction("kill",UpgraderKillHook)



